<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cello Fingering Finder - Metodika v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .concat-id { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
        .narrow { color: #1e40af; background-color: #eff6ff; border-color: #dbeafe; }
        .wide { color: #92400e; background-color: #fffbeb; border-color: #fef3c7; }
        .result-step { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden border border-slate-200">
        <header class="bg-indigo-950 p-8 text-white">
            <h1 class="text-3xl font-black tracking-tight italic">Cello Fingerboard Logic v7</h1>
            <p class="text-indigo-300 font-medium mt-2 uppercase text-xs tracking-widest">
                Priority: Polohová stabilita > Sudé dělení (2+2) > Anticipace extenze
            </p>
        </header>

        <div class="p-8 border-b border-slate-100 bg-slate-50">
            <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wider">
                Vstupní sekvence (zkus: e f# g# nebo d1 e1 f1 g1)
            </label>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="melodyInput" 
                       class="flex-1 p-4 text-xl border-2 border-slate-200 rounded-2xl focus:border-indigo-500 outline-none transition-all font-mono shadow-inner"
                       value="e f# g#">
                <button onclick="runSolver()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 px-10 rounded-2xl transition-all shadow-lg active:scale-95">
                    OPTIMALIZOVAT
                </button>
            </div>
        </div>

        <div id="resultsWrapper" class="p-8 hidden">
            <div id="pathDisplay" class="flex flex-wrap justify-center md:justify-start gap-4"></div>
            
            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-6 bg-emerald-50 rounded-2xl border border-emerald-100">
                    <h3 class="text-emerald-800 font-bold mb-2">Aktuální logické řešení:</h3>
                    <p id="analysisText" class="text-sm text-emerald-700">
                        Algoritmus nyní upřednostňuje stabilitu polohy. U sekvence <strong>e f# g#</strong> zůstane v I. poloze (D02) a použije široké držení, aby se vyhnul zbytečnému posunu.
                    </p>
                </div>
                <div class="p-6 bg-blue-50 rounded-2xl border border-blue-100">
                    <h3 class="text-blue-800 font-bold mb-2">Klíčové váhy:</h3>
                    <ul class="text-xs text-blue-700 space-y-2 list-disc ml-5">
                        <li><strong>Shift (5000):</strong> Skok polohou je nejdražší operace.</li>
                        <li><strong>Ext_Change (3000):</strong> Změna mezi úzkou a širokou dlaní v jedné poloze je drahá.</li>
                        <li><strong>Wide_Base (500):</strong> Samotná široká poloha je relativně levná, aby neodrazovala od stability.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="p-8 bg-white border-t border-slate-100 text-center">
            <button onclick="toggleJson()" class="text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">
                Zobrazit JSON Model
            </button>
            <div id="jsonContainer" class="hidden mt-4 bg-slate-900 rounded-2xl p-6 text-left overflow-hidden">
                <pre id="jsonDisplay" class="text-emerald-400 text-xs overflow-auto max-h-[300px]"></pre>
            </div>
        </div>
    </div>

    <script>
        // --- DATA GENERATION (Consistent with Ondra's JSON logic) ---
        function generateFingering(s, targetS) {
            if (targetS === 0) return [{ s, p: 0, f: 0, ext: 0 }];
            let options = [];
            for (let f = 1; f <= 4; f++) {
                let p = targetS - (f - 1);
                if (p >= 1 && p <= 12) options.push({ s, p, f, ext: 0 });
            }
            for (let f = 2; f <= 4; f++) {
                let offset = (f === 2) ? 2 : (f === 3 ? 3 : 4);
                let p = targetS - offset;
                if (p >= 1 && p <= 12) options.push({ s, p, f, ext: 1 });
            }
            return options;
        }

        const pitchDefs = [
            { n: "C", s: "C", v: 0 }, { n: "C#", s: "C", v: 1 }, { n: "D", s: "C", v: 2 }, { n: "D#", s: "C", v: 3 },
            { n: "E", s: "C", v: 4 }, { n: "F", s: "C", v: 5 }, { n: "F#", s: "C", v: 6 }, 
            { n: "G", strings: [{s:"G", v:0}, {s:"C", v:7}] }, { n: "G#", strings: [{s:"G", v:1}, {s:"C", v:8}] },
            { n: "A", strings: [{s:"G", v:2}, {s:"C", v:9}] }, { n: "A#", strings: [{s:"G", v:3}, {s:"C", v:10}] },
            { n: "H", strings: [{s:"G", v:4}, {s:"C", v:11}] }, { n: "c", strings: [{s:"G", v:5}, {s:"C", v:12}] },
            { n: "c#", s: "G", v: 6 }, { n: "d", strings: [{s:"D", v:0}, {s:"G", v:7}] }, { n: "d#", s: "G", v: 8 },
            { n: "e", strings: [{s:"D", v:2}, {s:"G", v:9}] }, { n: "f", strings: [{s:"D", v:3}, {s:"G", v:10}] },
            { n: "f#", strings: [{s:"D", v:4}, {s:"G", v:11}] }, { n: "g", strings: [{s:"D", v:5}, {s:"G", v:12}] },
            { n: "g#", s: "D", v: 6 }, { n: "a", strings: [{s:"A", v:0}, {s:"D", v:7}] }, { n: "a#", s: "D", v: 8 },
            { n: "h", strings: [{s:"A", v:2}, {s:"D", v:9}] }, { n: "c1", strings: [{s:"A", v:3}, {s:"D", v:10}] },
            { n: "c1#", s: "A", v: 4 }, { n: "d1", strings: [{s:"A", v:5}, {s:"D", v:12}] }, { n: "d1#", s: "A", v: 6 },
            { n: "e1", s: "A", v: 7 }, { n: "f1", s: "A", v: 8 }, { n: "f1#", s: "A", v: 9 }, { n: "g1", s: "A", v: 10 }
        ];

        const model = {};
        pitchDefs.forEach(d => {
            let opts = [];
            if (d.strings) d.strings.forEach(st => { opts = opts.concat(generateFingering(st.s, st.v)); });
            else opts = generateFingering(d.s, d.v);
            model[d.n] = opts;
        });

        document.getElementById('jsonDisplay').textContent = JSON.stringify(model, null, 2);

        // --- THE METODICAL ALGORITHM v7 ---

        function solve(sequence) {
            let layers = [];

            layers[0] = (model[sequence[0]] || []).map(opt => ({
                path: [opt],
                cost: (opt.p * 10) + (opt.ext * 500), 
                lastP: opt.p,
                groupSize: opt.f === 0 ? 0 : 1,
                hasWideInGroup: opt.ext === 1
            }));

            for (let i = 1; i < sequence.length; i++) {
                const note = sequence[i];
                const options = model[note];
                if (!options) continue;

                layers[i] = [];

                options.forEach(curr => {
                    let bestState = null;
                    let minTotalCost = Infinity;

                    layers[i-1].forEach(prevStep => {
                        const prev = prevStep.path[prevStep.path.length - 1];
                        let linkCost = 0;

                        const isSamePos = (curr.f !== 0 && prev.f !== 0 && curr.p === prev.p);
                        const isShift = (curr.f !== 0 && prev.f !== 0 && curr.p !== prev.p);

                        // 1. Shift Rules (Vysoká penalizace za pohyb paže)
                        if (isShift) {
                            linkCost += 5000; // Zásadní: Shift je extrémně drahý oproti extenzi
                            linkCost += Math.abs(curr.p - prev.p) * 100;
                            // Ochrana 2+2 (Penalizace lichých skupin před posunem)
                            if (prevStep.groupSize === 1) linkCost += 10000;
                            if (prevStep.groupSize === 3) linkCost += 5000;
                        }

                        // 2. Extension Consistency Logic (Fix pro e f# g#)
                        if (isSamePos) {
                            // Neutralita 1. prstu: změna extenze z/na 1. prst je OK.
                            // Ale změna mezi prsty 2-4 v jedné poloze je drahá.
                            if (prev.f > 1 && curr.f > 1 && prev.ext !== curr.ext) {
                                linkCost += 3000; 
                            }
                            // Anticipace: Pokud skupina vyžaduje extenzi, zůstaň v ní
                            if (prevStep.hasWideInGroup && curr.ext === 0 && curr.f > 1) {
                                linkCost += 2000; 
                            }
                        }

                        // 3. Wide Weight (Sníženo, aby Wide nebylo vnímáno hůř než Shift)
                        if (curr.ext === 1) linkCost += 500; 
                        
                        linkCost += curr.p * 10; 
                        if (prev.s !== curr.s) linkCost += 200; 

                        let total = prevStep.cost + linkCost;
                        if (total < minTotalCost) {
                            minTotalCost = total;
                            bestState = prevStep;
                        }
                    });

                    if (bestState) {
                        const prev = bestState.path[bestState.path.length - 1];
                        const samePos = (curr.p === prev.p && curr.f !== 0);
                        
                        layers[i].push({
                            path: [...bestState.path, curr],
                            cost: minTotalCost,
                            lastP: curr.p,
                            groupSize: samePos ? (bestState.groupSize + 1) : 1,
                            hasWideInGroup: samePos ? (bestState.hasWideInGroup || curr.ext === 1) : (curr.ext === 1)
                        });
                    }
                });
                
                layers[i].sort((a, b) => a.cost - b.cost);
                layers[i] = layers[i].slice(0, 100);
            }

            // Finální penalizace za osamocený tón na úplném konci
            return layers[sequence.length - 1]?.sort((a, b) => {
                let aLastPenalty = (a.groupSize === 1 || a.groupSize === 3) ? 10000 : 0;
                let bLastPenalty = (b.groupSize === 1 || b.groupSize === 3) ? 10000 : 0;
                return (a.cost + aLastPenalty) - (b.cost + bLastPenalty);
            })[0]?.path;
        }

        // --- UI ---

        function runSolver() {
            const inputVal = document.getElementById('melodyInput').value.trim();
            if (!inputVal) return;
            const input = inputVal.split(/\s+/);
            const result = solve(input);
            const display = document.getElementById('pathDisplay');
            const wrapper = document.getElementById('resultsWrapper');

            display.innerHTML = '';
            if (!result) {
                display.innerHTML = '<p class="text-red-500 font-bold p-4 text-center w-full">Tón mimo rozsah nebo neznámý zápis.</p>';
            } else {
                result.forEach((step, idx) => {
                    const id = `${step.s}${step.p.toString().padStart(2, '0')}${step.f}${step.ext}`;
                    const card = document.createElement('div');
                    card.className = `result-step flex flex-col items-center p-4 rounded-2xl border-2 shadow-sm min-w-[130px] ${step.ext === 1 ? 'wide' : 'narrow'}`;
                    card.style.animationDelay = `${idx * 0.1}s`;
                    card.innerHTML = `
                        <span class="text-[10px] uppercase font-black opacity-30 mb-1">${input[idx]}</span>
                        <span class="concat-id text-xl tracking-tighter">${id}</span>
                        <div class="flex items-center gap-1 mt-2">
                             <span class="w-2 h-2 rounded-full ${step.ext === 1 ? 'bg-amber-500' : 'bg-blue-600'}"></span>
                             <span class="text-[9px] font-bold uppercase tracking-widest opacity-70">
                                ${step.ext === 1 ? 'Široká' : 'Úzká'}
                             </span>
                        </div>
                    `;
                    display.appendChild(card);
                });
            }
            wrapper.classList.remove('hidden');
        }

        function toggleJson() {
            document.getElementById('jsonContainer').classList.toggle('hidden');
        }

        window.onload = runSolver;
    </script>
</body>
</html>
